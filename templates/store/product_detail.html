{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/custom.css' %}">

<section class="section-content bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen py-8">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 w-[90%]">
    {% include 'includes/alerts.html' %}
    
    <!-- ============================ PRODUCT CARD ================================= -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
      <div class="flex flex-col xl:flex-row">

        <!-- LEFT: Product Images -->
        <aside class="w-full xl:w-1/2 p-6 lg:p-8 bg-gray-50">
          <div class="gallery-wrap">
            <!-- Main Image Display -->
            <div class="img-big-wrap bg-white rounded-xl shadow-sm p-4 mb-6">
              <div class="text-center">
                <img id="mainImage" 
                     src="{{ single_product.images.url }}" 
                     alt="{{ single_product.product_name }}" 
                     class="inline-block object-contain max-h-80 md:max-h-96 w-auto mx-auto rounded-lg">
              </div>
            </div>
            
            <!-- Thumbnail Gallery -->
            <ul class="thumb flex flex-wrap justify-center gap-2">
              <li>
                <img src="{{ single_product.images.url }}" 
                     alt="Product Image" 
                     class="h-16 w-16 object-contain cursor-pointer border-2 border-blue-500 rounded-lg hover:shadow-md transition-all duration-200" 
                     onclick="changeImage(this)">
              </li>
              {% for img in product_gallery %}
              <li>
                <img src="{{ img.image.url }}" 
                     alt="Product Image" 
                     class="h-16 w-16 object-contain cursor-pointer border-2 border-gray-300 hover:border-blue-500 rounded-lg hover:shadow-md transition-all duration-200" 
                     onclick="changeImage(this)">
              </li>
              {% endfor %}
            </ul>
          </div>
        </aside>

        <!-- RIGHT: Product Details -->
        <main class="w-full xl:w-1/2 p-6 lg:p-8">
          <article class="content-body space-y-6">
            
            <!-- Product Title -->
            <div class="border-b border-gray-100 pb-4">
              <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 leading-tight">
                {{ single_product.product_name }}
              </h1>
            </div>

            <!-- Rating Section -->
            <div class="flex flex-wrap items-center gap-3 py-2">
              <div class="rating-star flex items-center">
                {% for star in avg_stars %}
                  <i class="{{ star }} text-yellow-400 text-base mr-1"></i>
                {% endfor %}
              </div>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">
                {{ single_product.countReview }} review{{ single_product.countReview|pluralize }}
              </span>
            </div>

            <!-- Price Section -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
              <div class="flex items-baseline gap-2">
                <span class="text-gray-600 font-medium text-sm">Price:</span>
                <var class="text-xl font-bold text-gray-900 not-italic">
                  Tk {{ single_product.price|floatformat:2 }}
                </var>
              </div>
            </div>

            <!-- Stock Status & Product Options -->
            {% if single_product.stock > 0 %}
              
              <!-- Stock Status Badge -->
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="bg-green-100 text-green-800 px-3 py-2 rounded-full text-sm font-medium inline-flex items-center gap-2">
                  <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                  In Stock
                </span>
                <span class="text-gray-600 text-sm">{{ single_product.stock }} items available</span>
              </div>

              {% regroup single_product.variation_set.all|dictsort:"variation_category" by variation_category as variation_groups %}

              <!-- Variation Selection -->
              {% if variation_groups %}
              <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-4">
                <h4 class="text-base font-semibold text-gray-900 mb-3">Product Options</h4>
                <div class="space-y-3">
                  {% for group in variation_groups %}
                    <div class="relative">
                      <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ group.grouper|capfirst }}:
                      </label>
                      <select name="{{ group.grouper|lower }}" 
                              id="select-{{ group.grouper|lower }}" 
                              class="w-full sm:w-2/3 border border-gray-300 rounded-lg px-3 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white" 
                              required>
                        <option value="" disabled selected>Choose {{ group.grouper|capfirst }}</option>
                        {% for item in group.list %}
                          {% if item.is_active %}
                            <option value="{{ item.variation_value }}">{{ item.variation_value|capfirst }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}

              <!-- Action Buttons -->
              <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <!-- Add to Cart Form -->
                <form id="cartForm" action="{% url 'add_cart' single_product.id %}" method="POST" class="flex-1">
                  {% csrf_token %}
                  <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                    <i class="fa fa-shopping-cart"></i>
                    <span>Add to Cart</span>
                  </button>
                </form>

                <!-- Add to Wishlist Form -->
                <form id="wishlistForm" action="{% url 'add_to_wishlist' single_product.id %}" method="POST" class="flex-1">
                  {% csrf_token %}
                  <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                    <i class="fa fa-heart"></i>
                    <span>Add to Wishlist</span>
                  </button>
                </form>
              </div>

            {% else %}
              <!-- Out of Stock -->
              <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <div class="flex items-center justify-center gap-3 mb-2">
                  <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                  <span class="text-red-700 font-bold text-2xl">Out of Stock</span>
                </div>
                <p class="text-red-600 text-sm">This product is currently unavailable</p>
              </div>
            {% endif %}

            <!-- Description -->
            <div class="prose prose-gray max-w-none">
              <h3 class="text-lg font-semibold text-gray-900 mb-3 mt-12">Product Description</h3>
              <div class="text-gray-700 leading-relaxed bg-gray-50 rounded-lg p-4 border border-gray-200">
                {{ single_product.description|safe }}
              </div>
            </div>

          </article>
        </main>
      </div>
    </div>
    <!-- ============================ PRODUCT CARD END ================================= -->

    <!-- ============================ REVIEW SECTION ================================= -->
    <div class="mt-12 space-y-8">

      <!-- Write Your Review -->
      <div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8 border border-gray-100">
        <div class="border-b border-gray-200 pb-4 mb-6">
          <h2 class="text-2xl lg:text-3xl font-bold text-gray-900">Write Your Review</h2>
          <p class="text-gray-600 mt-1">Share your experience with other customers</p>
        </div>

        <form action="{% url 'submit_review' single_product.id %}" method="POST" class="space-y-6">
          {% csrf_token %}

          <!-- Rating -->
          <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            <label class="block text-lg font-semibold text-gray-900 mb-3">How do you rate this product?</label>
            <div class="rating flex flex-row-reverse justify-end space-x-1">
              {% for i in "54321" %}
                <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" class="hidden peer" required />
                <label for="star{{ i }}" class="cursor-pointer text-gray-300 text-3xl peer-checked:text-yellow-400 hover:text-yellow-400 transition-colors duration-200 mr-1">
                  <i class="fas fa-star"></i>
                </label>
              {% endfor %}
            </div>
          </div>

          <!-- Review Title -->
          <div>
            <label class="block text-lg font-semibold text-gray-900 mb-2">Review Title</label>
            <input type="text" name="subject" 
                   class="w-full border border-gray-300 rounded-xl py-3 px-4 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                   placeholder="Summarize your review in a few words">
          </div>

          <!-- Review Content -->
          <div>
            <label class="block text-lg font-semibold text-gray-900 mb-2">Your Review</label>
            <textarea name="review" rows="5" 
                      class="w-full border border-gray-300 rounded-xl py-3 px-4 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none"
                      placeholder="Tell us about your experience with this product..."></textarea>
          </div>

          <!-- Submit Section -->
          <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            {% if user.is_authenticated %}
              {% if orderproduct %}
                <button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                  Submit Review
                </button>
              {% else %}
                <div class="flex items-center gap-3 text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-4">
                  <i class="fa fa-exclamation-triangle text-xl"></i>
                  <p class="font-medium">You must purchase this product to post a review.</p>
                </div>
              {% endif %}
            {% else %}
              <div class="flex items-center gap-3 text-blue-700 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <i class="fa fa-info-circle text-xl"></i>
                <p class="font-medium">
                  You must be logged in to post a review. 
                  <a href="{% url 'login' %}" class="text-blue-600 hover:text-blue-900 font-semibold">Login now</a>
                </p>
              </div>
            {% endif %}
          </div>
        </form>
      </div>

      <!-- Customer Reviews -->
      <div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8 border border-gray-100">
        <div class="border-b border-gray-200 pb-4 mb-8">
          <h2 class="text-2xl lg:text-3xl font-bold text-gray-900">Customer Reviews</h2>
          <p class="text-gray-600 mt-1">What our customers are saying</p>
        </div>

        <div class="space-y-6">
          {% for review in reviews %}
            <article class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:shadow-md transition-shadow duration-200">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                    {{ review.user.full_name|first|upper }}
                  </div>
                  <div>
                    <h6 class="font-semibold text-gray-900">{{ review.user.full_name }}</h6>
                    <span class="text-gray-500 text-sm">{{ review.updated_at }}</span>
                  </div>
                </div>

                <div class="rating-star flex items-center gap-1 bg-white rounded-lg px-3 py-1 border border-gray-300">
                  {% for star in review.stars %}
                    <i class="{{ star }} text-yellow-400"></i>
                  {% endfor %}
                </div>
              </div>

              <div class="space-y-3">
                <h6 class="font-semibold text-gray-900 text-lg">{{ review.subject }}</h6>
                <p class="text-gray-700 leading-relaxed">{{ review.review }}</p>
              </div>
            </article>
          {% empty %}
            <div class="text-center py-12">
              <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-comments text-2xl text-gray-400"></i>
              </div>
              <p class="text-gray-500 text-lg">No reviews yet for this product.</p>
              <p class="text-gray-400 text-sm mt-1">Be the first to share your experience!</p>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>
    <!-- ============================ REVIEW SECTION END ================================= -->

  </div>
</section>

<!-- Enhanced Styles -->
<style>
  /* Review Stars Enhanced */
  .rating label:hover,
  .rating label:hover ~ label,
  .rating input:checked ~ label {
    color: #fbbf24;
    transform: scale(1.1);
    transition: all 0.2s ease;
  }

  /* Smooth transitions for interactive elements */
  .gallery-wrap img:hover {
    transform: scale(1.05);
    transition: transform 0.3s ease;
  }

  /* Custom scrollbar for better UX */
  .content-body::-webkit-scrollbar {
    width: 6px;
  }

  .content-body::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .content-body::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .content-body::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Subtle animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .content-body > * {
    animation: fadeInUp 0.6s ease-out;
  }
</style>

<!-- ImageGallery Script -->
<script>
function changeImage(el) {
  const mainImage = document.getElementById('mainImage');
  mainImage.src = el.src;
  
  // Update thumbnail borders
  document.querySelectorAll('.thumb img').forEach(img => {
    img.classList.remove('border-blue-500');
    img.classList.add('border-gray-300');
  });
  
  el.classList.remove('border-gray-300');
  el.classList.add('border-blue-500');
}
</script>

<!-- Variation Form Script -->
<script>
    const variationGroups = {{ variation_groups|length }};
    const cartForm = document.getElementById('cartForm');
    const wishlistForm = document.getElementById('wishlistForm');

    // Copy selected variations to both forms on submit
    function copyVariations(form) {
      {% for group in variation_groups %}
        let value = document.getElementById('select-{{ group.grouper|lower }}').value;
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = '{{ group.grouper|lower }}';
        input.value = value;
        form.appendChild(input);
      {% endfor %}
    }

    cartForm.addEventListener('submit', function() {
      copyVariations(cartForm);
    });

    wishlistForm.addEventListener('submit', function() {
      copyVariations(wishlistForm);
    });
</script>

{% endblock %}