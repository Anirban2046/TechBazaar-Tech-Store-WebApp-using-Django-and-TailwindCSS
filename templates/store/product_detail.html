{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/custom.css' %}">

<section class="section-content bg-gray-50 py-6">
  <div class="container mx-auto px-2 sm:px-4 lg:px-6">
    {% include 'includes/alerts.html' %}
    <!-- ============================ PRODUCT CARD ================================= -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="flex flex-col lg:flex-row">

        <!-- LEFT: Product Images -->
        <aside class="w-full lg:w-1/2 p-4">
          <div class="gallery-wrap mb-4">
            <div class="img-big-wrap text-center mb-3">
              <img id="mainImage" src="{{ single_product.images.url }}" alt="{{ single_product.product_name }}" class="inline-block object-contain max-h-96">
            </div>
            <ul class="thumb flex flex-wrap justify-center gap-2">
              <li>
                <img src="{{ single_product.images.url }}" alt="Product Image" class="h-16 object-contain cursor-pointer" onclick="changeImage(this)">
              </li>
              {% for img in product_gallery %}
              <li>
                <img src="{{ img.image.url }}" alt="Product Image" class="h-16 object-contain cursor-pointer" onclick="changeImage(this)">
              </li>
              {% endfor %}
            </ul>
          </div>
        </aside>

        <!-- RIGHT: Product Details -->
        <main class="w-full lg:w-1/2 border-t lg:border-t-0 lg:border-l p-4 lg:p-6">

          <article class="content-body">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-2">{{ single_product.product_name }}</h2>

            <!-- Average Rating -->
            <div class="rating-star flex items-center mb-3">
              {% for star in avg_stars %}
                <i class="{{ star }} text-yellow-400 mr-1"></i>
              {% endfor %}
              <span class="ml-2 text-gray-600">{{ single_product.countReview }} reviews</span>
            </div>

            <!-- Price -->
            <div class="mb-4">
              <var class="text-2xl font-bold">Tk {{ single_product.price|floatformat:2 }}</var>
            </div>

            <!-- Description -->
            <p class="mb-4">{{ single_product.description|safe }}</p>
            <hr class="my-4">

            {% comment %} <!-- Color Selection -->
            <div class="mb-4">
              <h6 class="font-medium mb-1">Choose Color</h6>
              <div class="inline-block w-1/2">
                <select name="color" class="w-full border border-gray-300 rounded py-2 px-3" required>
                  <option value="" disabled selected>Select</option>
                  {% for i in single_product.variation_set.colors %}
                    <option value="{{ i.variation_value|lower }}">{{ i.variation_value|capfirst }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <hr class="my-4"> {% endcomment %}

            <!-- STOCK & ADD TO CART -->
              {% if single_product.stock > 0 %}

                {% regroup single_product.variation_set.all|dictsort:"variation_category" by variation_category as variation_groups %}

                <!-- Variation Selection (only one set) -->
                <div class="mb-4">
                  {% for group in variation_groups %}
                    <div class="mb-2">
                      <label class="text-base text-gray-700 font-medium">{{ group.grouper|capfirst }}:</label>
                      <select name="{{ group.grouper|lower }}" id="select-{{ group.grouper|lower }}" class="border rounded-lg p-1 w-2/3 sm:w-1/4" required>
                        <option value="" disabled selected>Choose {{ group.grouper|capfirst }}</option>
                        {% for item in group.list %}
                          {% if item.is_active %}
                            <option value="{{ item.variation_value }}">{{ item.variation_value|capfirst }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  {% endfor %}
                </div>

                <div class="flex flex-col gap-2 mt-2 items-start">
                  <!-- Add to Cart Form -->
                  <form id="cartForm" action="{% url 'add_cart' single_product.id %}" method="POST" class="flex flex-col gap-2 items-start">
                    {% csrf_token %}
                    <button type="submit" class="bg-blue-500 text-white py-2 px-9 rounded hover:bg-blue-600 flex items-center gap-2 text-sm mt-4">
                      <span>Add to Cart</span> <i class="fa fa-shopping-cart"></i>
                    </button>
                  </form>

                  <!-- Add to Wishlist Form -->
                  <form id="wishlistForm" action="{% url 'add_to_wishlist' single_product.id %}" method="POST" class="flex flex-col gap-2 items-start">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 text-white py-2 px-6 rounded hover:bg-red-600 flex items-center gap-2 text-sm">
                      <span>Add to Wishlist</span> <i class="fa fa-heart"></i>
                    </button>
                  </form>
                </div>
              {% endif %}

              </div>
              </div>       
            </article>
          </form>
        </main>
      </div>
    </div>
    <!-- ============================ PRODUCT CARD END ================================= -->

    <!-- ============================ REVIEW FORM ================================= -->
    <div class="container mx-auto px-2 sm:px-4 lg:px-6 mt-8">
      <form action="{% url 'submit_review' single_product.id %}" method="POST">
        {% csrf_token %}
        <h5 class="text-xl font-semibold mb-3">Write Your Review</h5>

        <!-- Rating -->
        <div class="mb-4">
          <label class="block font-medium mb-1">How do you rate this product?</label>
            <div class="rate">
              <input type="radio" id="rating10" name="rating" value="5" required /><label for="rating10" title="5"></label>
              <input type="radio" id="rating9" name="rating" value="4.5" required /><label for="rating9" class="half" title="4.5"></label>
              <input type="radio" id="rating8" name="rating" value="4" required /><label for="rating8" title="4"></label>
              <input type="radio" id="rating7" name="rating" value="3.5" required /><label for="rating7" class="half" title="3.5"></label>
              <input type="radio" id="rating6" name="rating" value="3" required /><label for="rating6" title="3"></label>
              <input type="radio" id="rating5" name="rating" value="2.5" required /><label for="rating5" class="half" title="2.5"></label>
              <input type="radio" id="rating4" name="rating" value="2" required /><label for="rating4" title="2"></label>
              <input type="radio" id="rating3" name="rating" value="1.5" required /><label for="rating3" class="half" title="1.5"></label>
              <input type="radio" id="rating2" name="rating" value="1" required /><label for="rating2" title="1"></label>
              <input type="radio" id="rating1" name="rating" value="0.5" required /><label for="rating1" class="half" title="0.5"></label>
            </div>
        <!-- Review Title -->
        <div class="mb-4">
          <label class="block font-medium mb-1">Review Title</label>
          <input type="text" name="subject" class="w-full border border-gray-300 rounded py-2 px-3">
        </div>

        <!-- Review Content -->
        <div class="mb-4">
          <label class="block font-medium mb-1">Review</label>
          <textarea name="review" rows="4" class="w-full border border-gray-300 rounded py-2 px-3"></textarea>
        </div>

        <!-- Submit -->
        {% if user.is_authenticated %}
          {% if orderproduct %}
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Submit Review</button>
          {% else %}
            <p class="text-red-600">You must purchase this product to post a review.</p>
          {% endif %}
        {% else %}
          <p class="text-red-600">You must be logged in to post a review. 
            <a href="{% url 'login' %}" class="text-blue-500 hover:underline">Login now</a>
          </p>
        {% endif %}
      </form>
    </div>
    <!-- ============================ REVIEW FORM END ================================= -->

    <!-- ============================ CUSTOMER REVIEWS ================================= -->
    <div class="container mx-auto px-2 sm:px-4 lg:px-6 mt-8">
      <h3 class="text-xl font-semibold mb-4">Customer Reviews</h3>
      {% for review in reviews %}
        <article class="bg-white rounded-lg shadow-sm p-4 mb-4">
          <div class="flex justify-between items-center mb-2">
            <h6 class="font-semibold">{{ review.user.full_name }}</h6>
            <span class="text-gray-500 text-sm">{{ review.updated_at }}</span>
          </div>

          <div class="rating-star mb-2">
            {% for star in review.stars %}
              <i class="{{ star }} text-yellow-400 mr-1"></i>
            {% endfor %}
          </div>

          <h6 class="font-semibold mb-1">{{ review.subject }}</h6>
          <p>{{ review.review }}</p>
        </article>
      {% empty %}
        <p>No reviews yet for this product.</p>
      {% endfor %}
    </div>
    <!-- ============================ CUSTOMER REVIEWS END ================================= -->

  </div>
</section>


<!-- ImageGallery Script -->
<script>
function changeImage(el) {
  document.getElementById('mainImage').src = el.src;
}
</script>

<!-- Variation Form Script -->
<script>
    const variationGroups = {{ variation_groups|length }};
    const cartForm = document.getElementById('cartForm');
    const wishlistForm = document.getElementById('wishlistForm');

    // Copy selected variations to both forms on submit
    function copyVariations(form) {
      {% for group in variation_groups %}
        let value = document.getElementById('select-{{ group.grouper|lower }}').value;
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = '{{ group.grouper|lower }}';
        input.value = value;
        form.appendChild(input);
      {% endfor %}
    }

    cartForm.addEventListener('submit', function() {
      copyVariations(cartForm);
    });

    wishlistForm.addEventListener('submit', function() {
      copyVariations(wishlistForm);
    });
  </script>

{% endblock %}
