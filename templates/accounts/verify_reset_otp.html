{% extends 'base.html' %}
{% block content %}

<section class="min-h-[83vh] otp-container flex items-start justify-center pt-2 xs:pt-3 sm:pt-4 md:pt-6 lg:pt-8">
  <div class="otp-card w-full xs:w-11/12 mb-4 xs:mb-6 sm:mb-8 max-w-xs xs:max-w-sm sm:max-w-md md:max-w-lg lg:max-w-xl bg-white rounded-lg xs:rounded-xl sm:rounded-2xl shadow-lg xs:shadow-xl overflow-hidden">
    {% include 'includes/alerts.html' %}

    <!-- Header Section -->
    <div class="otp-header p-1.5 xs:p-2 sm:p-3 relative mt-2 xs:mt-3 sm:mt-4">
      <div class="text-center">
        <div class="otp-icon w-8 h-8 xs:w-9 xs:h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 mx-auto mb-1 xs:mb-1.5 sm:mb-2 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center shadow-md xs:shadow-lg">
          <i class="fa fa-key text-white text-xs xs:text-sm sm:text-base md:text-lg"></i>
        </div>
        <h4 class="text-sm xs:text-base sm:text-lg md:text-xl font-bold text-white mb-0.5 xs:mb-1">Verify OTP</h4>
        <p class="text-amber-100 text-xs xs:text-xs sm:text-sm opacity-90">
          Password reset verification
        </p>
      </div>
    </div>

    <!-- Content Section -->
    <div class="otp-content p-3 xs:p-4 sm:p-6">
      <!-- Info Section -->
      <div class="info-section mb-3 xs:mb-4">
        <div class="flex items-center gap-2 xs:gap-3 bg-amber-50 rounded-lg xs:rounded-xl p-2 xs:p-3 border border-amber-200">
          <div class="info-icon w-6 h-6 xs:w-7 xs:h-7 sm:w-8 sm:h-8 bg-amber-100 rounded-md xs:rounded-lg flex items-center justify-center flex-shrink-0">
            <i class="fa fa-envelope text-amber-600 text-xs xs:text-sm"></i>
          </div>
          <p class="text-amber-800 text-xs xs:text-sm sm:text-base flex-1">
            Enter the OTP sent to your email address.
          </p>
        </div>
      </div>

      <!-- OTP Form -->
      <div class="form-section mb-3 xs:mb-4">
        <form method="POST" class="space-y-3 xs:space-y-4" id="otpForm">
          {% csrf_token %}
          
          <!-- OTP Input -->
          <div class="otp-input-group">
            <label class="input-label mb-2 xs:mb-3 text-xs xs:text-sm font-semibold text-gray-700 flex items-center justify-center">
              Enter your 6-digit verification code
            </label>
            <div class="otp-input-wrapper flex justify-center gap-2 xs:gap-3 sm:gap-4">
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
              <input type="text" maxlength="1" class="otp-digit w-10 h-10 xs:w-12 xs:h-12 sm:w-14 sm:h-14 text-center text-lg xs:text-xl sm:text-2xl font-mono font-bold border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors" />
            </div>
            <!-- Hidden input for form submission -->
            <input type="hidden" name="otp" id="hiddenOtp" />
          </div>

          <!-- Submit Button -->
          <button type="submit" class="verify-btn w-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-semibold py-2 xs:py-2.5 sm:py-3 rounded-lg xs:rounded-xl 
                     hover:from-amber-700 hover:to-amber-800 transition-all duration-300 transform hover:scale-[1.02] 
                     active:scale-[0.98] text-xs xs:text-sm sm:text-base md:text-lg shadow-md xs:shadow-lg hover:shadow-xl flex items-center justify-center gap-1.5 xs:gap-2">
            <i class="fa fa-check-circle text-xs xs:text-sm sm:text-base"></i>
            Verify OTP
          </button>
        </form>
      </div>
        
        <!-- Timer + Resend Section -->
        <div class="resend-section bg-gray-50 rounded-lg xs:rounded-xl p-2.5 xs:p-3 border border-gray-200">
          <div class="text-center">
            <div class="timer-display mb-1.5 xs:mb-2">
              <div class="timer-icon w-4 h-4 xs:w-5 xs:h-5 mx-auto mb-0.5 xs:mb-1 text-gray-500 flex items-center justify-center">
                <i class="fa fa-clock text-xs xs:text-sm"></i>
              </div>
              <p id="timer" class="text-gray-600 text-xs xs:text-xs sm:text-sm font-medium"></p>
            </div>
            
            <form action="{% url 'resend_reset_otp' %}" method="POST" id="resendForm">
              {% csrf_token %}
              <button type="submit" id="resendBtn" disabled
                class="resend-btn w-full bg-gray-300 text-gray-500 font-medium py-1.5 xs:py-2 sm:py-2.5 rounded-lg xs:rounded-xl cursor-not-allowed
                       disabled:opacity-60 transition-all duration-300 text-xs xs:text-xs sm:text-sm
                       flex items-center justify-center gap-1.5 xs:gap-2">
                <i class="fa fa-redo-alt text-xs xs:text-sm"></i>
                <span id="resendText">Resend OTP</span>
              </button>
            </form>
          </div>

        </div>
          <span class="block text-center text-gray-600 text-xs xs:text-sm mt-3 xs:mt-4 italic font-semibold">
            Or, you can also reset your password by clicking the link sent to your email.
          </span>
    </div>

  </div>

</section>

<style>
.otp-container {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    position: relative;
}

.otp-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 20%, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(251, 191, 36, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

.otp-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
    border: 1px solid #e2e8f0;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 1;
}

.otp-header {
    background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
    position: relative;
    overflow: hidden;
}

.otp-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
}

.otp-icon {
    animation: pulse 3s infinite;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.info-section {
    animation: fadeInUp 0.6s ease-out 0.2s both;
}

.form-section {
    animation: fadeInUp 0.6s ease-out 0.4s both;
}

.resend-btn {
    transition: all 0.3s ease;
}

.resend-btn:not(:disabled) {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.resend-btn:not(:disabled):hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

/* Animations */
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.verify-btn {
    box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
}

.verify-btn:hover {
    box-shadow: 0 15px 35px rgba(245, 158, 11, 0.4);
}

.verify-btn:active {
    background: linear-gradient(135deg, #b45309 0%, #d97706 100%);
}

.timer-active {
    color: #dc2626 !important;
    font-weight: 600;
}

@media (max-width: 475px) {
    .otp-card {
        margin: 0 8px;
    }
}
</style>

<!-- Safer JSON script for expiry -->
{% if request.session.otp_expiry %}
  {{ request.session.otp_expiry|json_script:"otp-expiry" }}
{% else %}
  <script id="otp-expiry" type="application/json">0</script>
{% endif %}

<!-- Enhanced Countdown Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const resendBtn = document.getElementById("resendBtn");
  const resendText = document.getElementById("resendText");
  const timerElement = document.getElementById("timer");
  const otpDigits = document.querySelectorAll('.otp-digit');
  const hiddenOtp = document.getElementById('hiddenOtp');
  const otpForm = document.getElementById('otpForm');
  const verifyBtn = document.querySelector('.verify-btn');

  // Parse expiry from safe JSON
  let expiry = JSON.parse(document.getElementById("otp-expiry").textContent);

  function validateOtp() {
    const otp = Array.from(otpDigits).map(input => input.value).join('');
    return otp.length === 6 && /^\d{6}$/.test(otp);
  }

  function updateTimer() {
    const now = Math.floor(Date.now() / 1000);
    let remaining = expiry - now;

    if (remaining <= 0) {
      resendBtn.disabled = false;
      resendBtn.classList.remove("bg-gray-300", "text-gray-500", "cursor-not-allowed");
      timerElement.textContent = "✓ You can now resend OTP";
      timerElement.classList.add("text-green-600", "font-semibold");
      resendText.textContent = "Resend OTP";
    } else {
      let minutes = Math.floor(remaining / 60);
      let seconds = remaining % 60;
      timerElement.textContent = `⏰ Resend available in ${minutes}:${seconds.toString().padStart(2,'0')}`;
      timerElement.classList.add("timer-active");
      resendText.textContent = `Wait ${minutes}:${seconds.toString().padStart(2,'0')}`;
      
      setTimeout(updateTimer, 1000);
    }
  }

  if (expiry > 0) {
    updateTimer();
  } else {
    resendBtn.disabled = false;
    resendBtn.classList.remove("bg-gray-300", "text-gray-500", "cursor-not-allowed");
    timerElement.textContent = "✓ Ready to send OTP";
    timerElement.classList.add("text-green-600", "font-semibold");
  }

  otpDigits.forEach((digit, index) => {
    digit.addEventListener('input', function(e) {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value;

      if (value && index < otpDigits.length - 1) {
        otpDigits[index + 1].focus();
      }

      updateHiddenOtp();
    });

    digit.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        otpDigits[index - 1].focus();
      }
    });

    digit.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
      
      pastedData.split('').forEach((char, i) => {
        if (i < otpDigits.length) {
          otpDigits[i].value = char;
        }
      });
      
      updateHiddenOtp();
      
      const lastIndex = Math.min(pastedData.length - 1, otpDigits.length - 1);
      otpDigits[lastIndex].focus();
    });
  });

  function updateHiddenOtp() {
    const otp = Array.from(otpDigits).map(input => input.value).join('');
    hiddenOtp.value = otp;
    
    if (otp.length === 6 && validateOtp()) {
      setTimeout(() => {
        otpForm.submit();
      }, 500);
    }
  }

  otpDigits[0].focus();

  otpForm.addEventListener('submit', function(e) {
    if (!validateOtp()) {
      e.preventDefault();
      alert('Please enter all 6 digits of the OTP');
      return false;
    }
    
    verifyBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Verifying...';
    verifyBtn.disabled = true;
  });
});
</script>

{% endblock %}